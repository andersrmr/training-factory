{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "type": "object",
  "required": [
    "request",
    "research",
    "research_qa",
    "brief",
    "curriculum",
    "lab",
    "slides",
    "templates",
    "qa"
  ],
  "properties": {
    "request": {
      "type": "object",
      "required": ["topic", "audience"],
      "properties": {
        "topic": {"type": "string"},
        "audience": {"type": "string"}
      },
      "additionalProperties": true
    },
    "brief": {
      "type": "object",
      "required": [
        "topic",
        "audience",
        "goals",
        "constraints",
        "references_used",
        "key_guidelines"
      ],
      "properties": {
        "topic": {"type": "string"},
        "audience": {"type": "string"},
        "goals": {"type": "array", "items": {"type": "string"}},
        "constraints": {"type": "array", "items": {"type": "string"}},
        "references_used": {
          "type": "array",
          "minItems": 1,
          "items": {"type": "string", "minLength": 1}
        },
        "key_guidelines": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "required": ["guideline", "rationale", "sources"],
            "properties": {
              "guideline": {"type": "string", "minLength": 1},
              "rationale": {"type": "string", "minLength": 1},
              "sources": {
                "type": "array",
                "minItems": 1,
                "items": {"type": "string", "minLength": 1}
              }
            },
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false
    },
    "research": {
      "type": "object",
      "required": ["query_plan", "sources", "context_pack"],
      "properties": {
        "query_plan": {
          "type": "object",
          "required": ["queries", "intent_keywords", "preferred_domains", "product"],
          "properties": {
            "queries": {
              "type": "array",
              "items": { "type": "string" }
            },
            "intent_keywords": {
              "type": "array",
              "items": { "type": "string" }
            },
            "preferred_domains": {
              "type": "array",
              "items": { "type": "string" }
            },
            "product": {
              "type": "string",
              "enum": [
                "power_bi",
                "power_apps",
                "power_platform",
                "enterprise_chatgpt",
                "generic"
              ]
            }
          },
          "additionalProperties": false
        },
        "sources": {
          "type": "array",
          "items": {
            "type": "object",
            "required": [
              "id",
              "title",
              "url",
              "domain",
              "publisher",
              "doc_type",
              "authority_tier",
              "score",
              "snippets"
            ],
            "properties": {
              "id": { "type": "string" },
              "title": { "type": "string" },
              "url": { "type": "string" },
              "domain": { "type": "string" },
              "publisher": { "type": "string" },
              "doc_type": { "type": "string" },
              "retrieved_at": { "type": "string" },
              "authority_tier": { "type": "string", "enum": ["A", "B", "C", "D"] },
              "score": { "type": "number" },
              "snippets": {
                "type": "array",
                "items": {
                  "type": "object",
                  "required": ["heading", "text", "loc"],
                  "properties": {
                    "heading": { "type": "string" },
                    "text": { "type": "string" },
                    "loc": { "type": "string" }
                  },
                  "additionalProperties": false
                }
              }
            },
            "additionalProperties": false
          }
        },
        "context_pack": { "type": "string", "minLength": 1 }
      },
      "additionalProperties": false
    },
    "research_qa": {
      "type": "object",
      "required": ["status", "checks", "metrics"],
      "properties": {
        "status": { "type": "string", "enum": ["pass", "fail"] },
        "checks": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["prompt", "answer"],
            "properties": {
              "prompt": { "type": "string" },
              "answer": { "type": "string", "enum": ["Yes", "No"] }
            },
            "additionalProperties": false
          }
        },
        "metrics": {
          "type": "object",
          "required": ["tier_counts", "domain_counts", "keyword_coverage_ratio"],
          "properties": {
            "tier_counts": {
              "type": "object",
              "required": ["A", "B", "C", "D"],
              "properties": {
                "A": { "type": "integer", "minimum": 0 },
                "B": { "type": "integer", "minimum": 0 },
                "C": { "type": "integer", "minimum": 0 },
                "D": { "type": "integer", "minimum": 0 }
              },
              "additionalProperties": false
            },
            "domain_counts": {
              "type": "object",
              "additionalProperties": { "type": "integer", "minimum": 0 }
            },
            "keyword_coverage_ratio": { "type": "number", "minimum": 0, "maximum": 1 }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "curriculum": {
      "type": "object",
      "required": ["topic", "audience", "modules", "references_used"],
      "properties": {
        "topic": {"type": "string"},
        "audience": {"type": "string"},
        "references_used": {
          "type": "array",
          "minItems": 1,
          "items": {"type": "string", "minLength": 1}
        },
        "modules": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["title", "duration_minutes", "sources"],
            "properties": {
              "title": {"type": "string"},
              "duration_minutes": {"type": "integer", "minimum": 1},
              "sources": {
                "type": "array",
                "minItems": 1,
                "items": {"type": "string", "minLength": 1}
              }
            },
            "additionalProperties": true
          }
        }
      },
      "additionalProperties": false
    },
    "lab": {
      "type": "object",
      "required": ["labs"],
      "properties": {
        "labs": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["title", "instructions", "expected_outcome"],
            "properties": {
              "title": {"type": "string"},
              "instructions": {"type": "array", "items": {"type": "string"}},
              "expected_outcome": {"type": "string"}
            },
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false
    },
    "slides": {
      "type": "object",
      "required": ["deck"],
      "properties": {
        "deck": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["slide", "title", "bullets"],
            "properties": {
              "slide": {"type": "integer", "minimum": 1},
              "title": {"type": "string"},
              "bullets": {"type": "array", "items": {"type": "string"}
              }
            },
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false
    },
    "templates": {
      "type": "object",
      "required": ["readme_md", "runbook_md"],
      "properties": {
        "readme_md": {
          "type": "object",
          "required": ["content"],
          "properties": {
            "content": {"type": "string", "minLength": 1}
          },
          "additionalProperties": false
        },
        "runbook_md": {
          "type": "object",
          "required": ["content"],
          "properties": {
            "content": {"type": "string", "minLength": 1}
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "qa": {
      "type": "object",
      "required": ["status", "checks"],
      "properties": {
        "status": {"type": "string", "enum": ["pass", "fail"]},
        "checks": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["prompt", "answer"],
            "properties": {
              "prompt": {"type": "string"},
              "answer": {"type": "string"}
            },
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}
